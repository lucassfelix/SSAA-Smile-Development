name: Deploy Godot Web (cache-busted) to GitHub Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Inject a build version into index.html so browsers always fetch the latest files.
      - name: Cache-bust index.html
        run: |
          set -e
          SHA=$(git rev-parse --short HEAD)
          HTML="index.html"

          if [ ! -f "$HTML" ]; then
            echo "index.html not found at repo root"
            exit 1
          fi

          # 1) Bust the index.js script tag
          # <script src="index.js"></script> -> <script src="index.js?v=SHA"></script>
          sed -i "s/src=\"index.js\"/src=\"index.js?v=$SHA\"/g" "$HTML" || true

          # 2) Bust the Godot file URLs referenced inside GODOT_CONFIG or loader code
          # These patterns match your export template.
          sed -i "s/index.pck/index.pck?v=$SHA/g" "$HTML" || true
          sed -i "s/index.wasm/index.wasm?v=$SHA/g" "$HTML" || true

          # Optional: bust splash image too (if present)
          sed -i "s/index.png/index.png?v=$SHA/g" "$HTML" || true

          echo "Cache-busted with v=$SHA"

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
